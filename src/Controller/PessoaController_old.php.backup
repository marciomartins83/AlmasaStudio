<?php

namespace App\Controller;

use App\Entity\Pessoas;
use App\Form\PessoaFormType;
use App\Repository\PessoaRepository;
use App\Form\PessoaCorretorType;
use App\Form\PessoaContratanteType;
use App\Form\PessoaFiadorType;
use App\Form\PessoaLocadorType;
use App\Entity\PessoasProfissoes;
use App\Form\PessoaPretendenteType;
use App\Form\PessoaCorretoraType;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use App\Entity\PessoasFiadores;
use App\Entity\PessoasCorretores;
use App\Entity\PessoasLocadores;
use App\Entity\PessoasPretendentes;
use App\Entity\PessoasContratantes;
use App\Entity\PessoasCorretoras;


#[Route('/pessoa', name: 'app_pessoa_')]
class PessoaController_old extends AbstractController
{
    #[Route('/', name: 'index', methods: ['GET'])]
    public function index(PessoaRepository $pessoaRepository): Response
    {
        return $this->render('pessoa/index.html.twig', [
            'pessoas' => $pessoaRepository->findAll(),
        ]);
    }

    #[Route('/new', name: 'new', methods: ['GET', 'POST'])]
    public function new(Request $request, EntityManagerInterface $entityManager): Response
    {
        $form = $this->createForm(PessoaFormType::class);
        $form->handleRequest($request);

        if ($form->isSubmitted() && $form->isValid()) {
            $data = $form->getData();
            $tipoPessoa = $form->get('tipoPessoa')->getData();

            $entityManager->beginTransaction();
            try {
                // 1. Criar e Salvar a Pessoa Principal
                $pessoa = new Pessoas();
                $pessoa->setNome($data['nome']);
                $pessoa->setDataNascimento($data['dataNascimento']);
                $pessoa->setEstadoCivil($data['estadoCivil']);
                $pessoa->setNacionalidade($data['nacionalidade']);
                $pessoa->setNaturalidade($data['naturalidade']);
                $pessoa->setNomePai($data['nomePai']);
                $pessoa->setNomeMae($data['nomeMae']);
                $pessoa->setRenda($data['renda']);
                $pessoa->setObservacoes($data['observacoes']);

                // TODO: Lógica para definir fisicaJuridica com base no CPF/CNPJ
                $pessoa->setFisicaJuridica('fisica'); // Placeholder
                $pessoa->setDtCadastro(new \DateTime());
                $pessoa->setStatus(true);
                $pessoa->setTipoPessoa(1); // Placeholder

                $entityManager->persist($pessoa);

                // 2. Criar e Salvar a Entidade Específica
                if (isset($data[$tipoPessoa]) && $data[$tipoPessoa] !== null) {
                    $subEntity = $data[$tipoPessoa];
                    $reflection = new \ReflectionClass($subEntity);
                    if ($reflection->hasMethod('setPessoa')) {
                        $method = $reflection->getMethod('setPessoa');
                        $method->invoke($subEntity, $pessoa);
                    }
                    
                    $entityManager->persist($subEntity);
                }
                
                // TODO: Salvar coleções (telefones, endereços, etc.) associadas à $pessoa

                $entityManager->flush();
                $entityManager->commit();

                $this->addFlash('success', 'Pessoa cadastrada com sucesso!');
                return $this->redirectToRoute('app_pessoa_index');

            } catch (\Exception $e) {
                $entityManager->rollback();
                $this->addFlash('error', 'Erro ao salvar: ' . $e->getMessage());
            }
        }

        return $this->render('pessoa/new.html.twig', [
            'form' => $form->createView(),
        ]);
    }

    #[Route('/_subform', name: '_subform', methods: ['POST'])]
    public function _subform(Request $request): Response
    {
        $tipo = $request->get('tipo');

        if (!$tipo) {
            return new Response('', 204);
        }

        // Tipos que só fazem vinculação (sem campos extras) - retornar vazio
        $tiposSemCampos = ['contratante'];
        if (in_array($tipo, $tiposSemCampos)) {
            return new Response('', 204);
        }

        $subFormType = null;
        $template = null;

        switch ($tipo) {
            case 'fiador':
                $subFormType = PessoaFiadorType::class;
                $template = 'pessoa/partials/fiador.html.twig';
                break;
            case 'corretor':
                $subFormType = PessoaCorretorType::class;
                $template = 'pessoa/partials/corretor.html.twig';
                break;
            case 'locador':
                $subFormType = PessoaLocadorType::class;
                $template = 'pessoa/partials/locador.html.twig';
                break;
            case 'pretendente':
                $subFormType = PessoaPretendenteType::class;
                $template = 'pessoa/partials/pretendente.html.twig';
                break;
            default:
                return new Response('', 204);
        }

        try {
            // Criar o sub-formulário diretamente com o tipo específico
            $form = $this->createForm($subFormType);

            // Renderizar o template parcial com a estrutura correta
            return $this->render($template, [
                'form' => $form->createView()
            ]);
            
        } catch (\Exception $e) {
            // Log do erro para debug
            error_log('Erro ao carregar sub-formulário: ' . $e->getMessage());
            
            return new Response('<div class="alert alert-danger">Erro ao carregar formulário: ' . $e->getMessage() . '</div>', 500);
        }
    }


    #[Route('/search-pessoa-advanced', name: 'search_pessoa_advanced', methods: ['POST'])]
    public function searchPessoaAdvanced(Request $request, PessoaRepository $pessoaRepository): JsonResponse
    {
        try {
            $data = json_decode($request->getContent(), true);
            
            if (!$data) {
                return new JsonResponse(['success' => false, 'message' => 'Dados JSON inválidos'], 400);
            }

            $criteria = $data['criteria'] ?? '';
            $value = $data['value'] ?? '';
            $additionalDoc = $data['additionalDoc'] ?? null;
            $additionalDocType = $data['additionalDocType'] ?? null;

            if (empty($criteria) || empty($value)) {
                return new JsonResponse(['success' => false, 'message' => 'Critério e valor são obrigatórios'], 400);
            }

            $pessoa = null;
            
            switch ($criteria) {
                case 'cpf':
                case 'CPF':
                case 'CPF (Pessoa Física)':
                    $pessoa = $pessoaRepository->findByCpf($value);
                    break;
                
                case 'cnpj':
                case 'CNPJ':
                case 'CNPJ (Pessoa Jurídica)':
                    $pessoa = $pessoaRepository->findByCnpj($value);
                    break;
                
                case 'id':
                case 'ID':
                case 'Id Pessoa':
                    $pessoa = $pessoaRepository->find((int)$value);
                    break;
                
                case 'nome':
                case 'Nome':
                case 'Nome Completo':
                    // Busca por nome + documento adicional
                    if ($additionalDoc && $additionalDocType) {
                        $isDocCpf = (stripos($additionalDocType, 'cpf') !== false);
                        $isDocCnpj = (stripos($additionalDocType, 'cnpj') !== false);
                        
                        if ($isDocCpf) {
                            $pessoaPorDoc = $pessoaRepository->findByCpf($additionalDoc);
                        } elseif ($isDocCnpj) {
                            $pessoaPorDoc = $pessoaRepository->findByCnpj($additionalDoc);
                        } else {
                            $pessoaPorDoc = null;
                        }

                        // Verificar se o nome confere
                        if ($pessoaPorDoc && stripos($pessoaPorDoc->getNome(), $value) !== false) {
                            $pessoa = $pessoaPorDoc;
                        }
                    } else {
                        // Busca apenas por nome (pode retornar múltiplos, pegamos o primeiro)
                        $pessoas = $pessoaRepository->findByNome($value);
                        if (count($pessoas) === 1) {
                            $pessoa = $pessoas[0];
                        } elseif (count($pessoas) > 1) {
                            return new JsonResponse([
                                'success' => false, 
                                'message' => 'Múltiplas pessoas encontradas com este nome. Por favor, informe o CPF ou CNPJ para especificar.'
                            ]);
                        }
                    }
                    break;
                
                default:
                    return new JsonResponse(['success' => false, 'message' => 'Critério de busca inválido'], 400);
            }

            if ($pessoa) {
                // Buscar documentos da pessoa
                $cpf = $pessoaRepository->getCpfByPessoa($pessoa->getIdpessoa());
                $cnpj = $pessoaRepository->getCnpjByPessoa($pessoa->getIdpessoa());
                
                return new JsonResponse([
                    'success' => true,
                    'pessoa' => [
                        'id' => $pessoa->getIdpessoa(),
                        'nome' => $pessoa->getNome(),
                        'cpf' => $cpf,
                        'cnpj' => $cnpj,
                        'fisicaJuridica' => $pessoa->getFisicaJuridica(),
                        'dataNascimento' => $pessoa->getDataNascimento() ? $pessoa->getDataNascimento()->format('Y-m-d') : null,
                        'estadoCivil' => $pessoa->getEstadoCivil() ? $pessoa->getEstadoCivil()->getId() : null,
                        'nacionalidade' => $pessoa->getNacionalidade() ? $pessoa->getNacionalidade()->getId() : null,
                        'naturalidade' => $pessoa->getNaturalidade() ? $pessoa->getNaturalidade()->getId() : null,
                        'nomePai' => $pessoa->getNomePai(),
                        'nomeMae' => $pessoa->getNomeMae(),
                        'renda' => $pessoa->getRenda(),
                        'observacoes' => $pessoa->getObservacoes(),
                    ]
                ]);
            } else {
                return new JsonResponse([
                    'success' => true,
                    'pessoa' => null,
                    'message' => 'Pessoa não encontrada'
                ]);
            }

        } catch (\Exception $e) {
            // Log do erro para debug
            error_log('Erro na busca de pessoa: ' . $e->getMessage());
            
            return new JsonResponse([
                'success' => false, 
                'message' => 'Erro interno: ' . $e->getMessage()
            ], 500);
        }
    }
    
    #[Route('/{id}', name: 'show', methods: ['GET'], requirements: ['id' => '\d+'])]
    public function show(Pessoas $pessoa): Response
    {
        return $this->render('pessoa/show.html.twig', [
            'pessoa' => $pessoa,
        ]);
    }

    #[Route('/{id}/edit', name: 'edit', methods: ['GET', 'POST'], requirements: ['id' => '\d+'])]
    public function edit(Request $request, Pessoas $pessoa, EntityManagerInterface $entityManager): Response
    {
        $form = $this->createForm(PessoaFormType::class, $pessoa);
        $form->handleRequest($request);

        if ($form->isSubmitted() && $form->isValid()) {
            $entityManager->flush();

            $this->addFlash('success', 'Pessoa atualizada com sucesso!');
            return $this->redirectToRoute('app_pessoa_index');
        }

        return $this->render('pessoa/edit.html.twig', [
            'pessoa' => $pessoa,
            'form' => $form->createView(),
        ]);
    }

    #[Route('/{id}', name: 'delete', methods: ['POST'], requirements: ['id' => '\d+'])]
    public function delete(Request $request, Pessoas $pessoa, EntityManagerInterface $entityManager): Response
    {
        if ($this->isCsrfTokenValid('delete'.$pessoa->getIdpessoa(), $request->request->get('_token'))) {
            $entityManager->remove($pessoa);
            $entityManager->flush();
            $this->addFlash('success', 'Pessoa excluída com sucesso.');
        }

        return $this->redirectToRoute('app_pessoa_index');
    }
}

