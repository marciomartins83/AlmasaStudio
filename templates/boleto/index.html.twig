{% extends 'base.html.twig' %}

{% block title %}Boletos - {{ parent() }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .stat-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card.pendentes { border-left-color: #6c757d; }
        .stat-card.registrados { border-left-color: #0d6efd; }
        .stat-card.pagos { border-left-color: #198754; }
        .stat-card.vencidos { border-left-color: #ffc107; }
        .stat-card.valor { border-left-color: #0dcaf0; }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .table-boletos th {
            white-space: nowrap;
        }
        .btn-acao {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .filtros-card {
            background: #f8f9fa;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include '_partials/breadcrumb.html.twig' with {
        'items': [
            {'label': 'Dashboard', 'url': path('app_dashboard')},
            {'label': 'Financeiro', 'url': '#'}
        ],
        'current': 'Boletos'
    } %}

    {# Flash messages #}
    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
    {% for message in app.flashes('warning') %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}

    {# Cabeçalho #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-barcode me-2"></i>Boletos
        </h1>
        <a href="{{ path('app_boleto_new') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Novo Boleto
        </a>
    </div>

    {# Cards de Estatísticas #}
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card stat-card pendentes h-100">
                <div class="card-body text-center py-3">
                    <div class="stat-value text-secondary">{{ estatisticas.pendentes }}</div>
                    <small class="text-muted">Pendentes</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card stat-card registrados h-100">
                <div class="card-body text-center py-3">
                    <div class="stat-value text-primary">{{ estatisticas.registrados }}</div>
                    <small class="text-muted">Registrados</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card stat-card pagos h-100">
                <div class="card-body text-center py-3">
                    <div class="stat-value text-success">{{ estatisticas.pagos }}</div>
                    <small class="text-muted">Pagos</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <div class="card stat-card vencidos h-100">
                <div class="card-body text-center py-3">
                    <div class="stat-value text-warning">{{ estatisticas.vencidos }}</div>
                    <small class="text-muted">Vencidos</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-8 col-xl-4">
            <div class="card stat-card valor h-100">
                <div class="card-body text-center py-3">
                    <div class="stat-value text-info">
                        R$ {{ estatisticas.valor_total_aberto|number_format(2, ',', '.') }}
                    </div>
                    <small class="text-muted">Valor em Aberto</small>
                </div>
            </div>
        </div>
    </div>

    {# Busca Avancada #}
    {% include '_partials/search_panel.html.twig' with {
        filterDefs: filterDefs,
        filters: filters,
        routeName: 'app_boleto_index',
        itemsPerPage: itemsPerPage,
        sortField: sortField,
        sortDir: sortDir
    } %}

    {# Ordenacao #}
    {% include '_partials/sort_panel.html.twig' with {
        sortOptions: sortOptions,
        sortField: sortField,
        sortDir: sortDir,
        routeName: 'app_boleto_index',
        filters: filters,
        itemsPerPage: itemsPerPage
    } %}

    {# Ações em Lote #}
    <div class="mb-3 d-flex gap-2 align-items-center" id="acoes-lote" style="display: none !important;">
        <span class="text-muted"><span id="qtd-selecionados">0</span> selecionado(s)</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-registrar-lote">
            <i class="fas fa-upload me-1"></i> Registrar Selecionados
        </button>
        <button type="button" class="btn btn-sm btn-outline-info" id="btn-consultar-lote">
            <i class="fas fa-sync me-1"></i> Consultar Selecionados
        </button>
    </div>

    {# Tabela de Boletos #}
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-boletos mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th width="40">
                                <input type="checkbox" class="form-check-input" id="selecionar-todos">
                            </th>
                            <th>Nosso Número</th>
                            <th>Pagador</th>
                            <th>Vencimento</th>
                            <th class="text-end">Valor</th>
                            <th width="120">Status</th>
                            <th width="180">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for boleto in boletos|default([]) %}
                        <tr data-boleto-id="{{ boleto.id }}">
                            <td>
                                <input type="checkbox" class="form-check-input checkbox-boleto"
                                       value="{{ boleto.id }}" data-status="{{ boleto.status }}">
                            </td>
                            <td>
                                <a href="{{ path('app_boleto_show', {id: boleto.id}) }}" class="text-decoration-none">
                                    <strong>{{ boleto.nossoNumero }}</strong>
                                </a>
                                {% if boleto.seuNumero %}
                                    <br><small class="text-muted">Doc: {{ boleto.seuNumero }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ boleto.pessoaPagador.nome|length > 35 ? boleto.pessoaPagador.nome|slice(0, 35) ~ '...' : boleto.pessoaPagador.nome }}
                            </td>
                            <td>
                                {{ boleto.dataVencimento|date('d/m/Y') }}
                                {% if boleto.isVencido and boleto.status != 'PAGO' and boleto.status != 'BAIXADO' %}
                                    <br><small class="text-danger">{{ boleto.diasAtraso }} dia(s) atraso</small>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                R$ {{ boleto.valorNominal|number_format(2, ',', '.') }}
                            </td>
                            <td>
                                <span class="badge {{ boleto.statusClass }}" id="status-{{ boleto.id }}">
                                    {{ boleto.statusLabel }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ path('app_boleto_show', {id: boleto.id}) }}"
                                       class="btn btn-outline-secondary btn-acao" title="Ver">
                                        <i class="fas fa-eye"></i>
                                    </a>

                                    {% if boleto.status == 'PENDENTE' %}
                                    <button type="button" class="btn btn-outline-primary btn-acao btn-registrar"
                                            data-id="{{ boleto.id }}" title="Registrar">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    {% endif %}

                                    {% if boleto.status == 'REGISTRADO' %}
                                    <button type="button" class="btn btn-outline-info btn-acao btn-consultar"
                                            data-id="{{ boleto.id }}" title="Consultar Status">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                    <a href="{{ path('app_boleto_imprimir', {id: boleto.id}) }}"
                                       class="btn btn-outline-success btn-acao" title="Imprimir" target="_blank">
                                        <i class="fas fa-print"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-warning btn-acao btn-baixar"
                                            data-id="{{ boleto.id }}" title="Baixar/Cancelar">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                    {% endif %}

                                    {% if boleto.status == 'PAGO' %}
                                    <a href="{{ path('app_boleto_imprimir', {id: boleto.id}) }}"
                                       class="btn btn-outline-success btn-acao" title="Imprimir" target="_blank">
                                        <i class="fas fa-print"></i>
                                    </a>
                                    {% endif %}

                                    {% if boleto.status == 'PENDENTE' %}
                                    <button type="button" class="btn btn-outline-danger btn-acao btn-excluir"
                                            data-id="{{ boleto.id }}" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                <i class="fas fa-barcode fa-3x mb-3 d-block"></i>
                                <span>Nenhum boleto encontrado</span><br>
                                <small>Clique em "Novo Boleto" para começar</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer">
            {% include '_partials/pagination.html.twig' with {
                totalItems: totalItems,
                currentPage: currentPage,
                itemsPerPage: itemsPerPage,
                totalPages: totalPages,
                routeName: 'app_boleto_index',
                filters: filters,
                sortField: sortField,
                sortDir: sortDir,
                showSearch: false
            } %}
        </div>
    </div>
</div>

{# Modal de Confirmação de Baixa #}
<div class="modal fade" id="modalBaixa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Baixa do Boleto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja baixar/cancelar este boleto?</p>
                <p class="text-muted small">Esta ação não pode ser desfeita.</p>
                <div class="mb-3">
                    <label class="form-label">Motivo da Baixa</label>
                    <select class="form-select" id="motivo-baixa">
                        <option value="SOLICITACAO_BENEFICIARIO">Solicitação do Beneficiário</option>
                        <option value="PAGAMENTO_DIRETO">Pagamento Direto ao Beneficiário</option>
                        <option value="SUBSTITUICAO">Substituição do Título</option>
                        <option value="OUTROS">Outros</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btn-confirmar-baixa">
                    <i class="fas fa-times-circle me-1"></i> Confirmar Baixa
                </button>
            </div>
        </div>
    </div>
</div>

{# Modal de Confirmação de Exclusão #}
<div class="modal fade" id="modalExcluir" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este boleto?</p>
                <p class="text-danger"><strong>Esta ação não pode ser desfeita!</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-exclusao">
                    <i class="fas fa-trash me-1"></i> Excluir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('crud_filters') }}
    {{ encore_entry_script_tags('boleto') }}

    <script>
        window.ROUTES = {
            registrar: '{{ path("app_boleto_registrar", {id: "__ID__"}) }}',
            consultar: '{{ path("app_boleto_consultar", {id: "__ID__"}) }}',
            baixar: '{{ path("app_boleto_baixar", {id: "__ID__"}) }}',
            deletar: '{{ path("app_boleto_delete", {id: "__ID__"}) }}',
            registrarLote: '{{ path("app_boleto_registrar_lote") }}',
            consultarLote: '{{ path("app_boleto_consultar_lote") }}'
        };
    </script>
{% endblock %}
