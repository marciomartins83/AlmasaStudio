{% extends 'base.html.twig' %}

{% block title %}{{ isEdit ? 'Editar' : 'Novo' }} Lançamento - {{ parent() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include '_partials/breadcrumb.html.twig' with {
        'items': [
            {'label': 'Dashboard', 'url': path('app_dashboard')},
            {'label': 'Ficha Financeira', 'url': path('app_financeiro_index')}
        ],
        'current': isEdit ? 'Editar Lançamento' : 'Novo Lançamento'
    } %}

    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}

    {% for message in app.flashes('error') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-file-invoice-dollar"></i>
                        {{ isEdit ? 'Editar Lançamento #' ~ lancamento.id : 'Novo Lançamento' }}
                    </h4>
                </div>
                <div class="card-body">
                    <form id="formLancamento" method="POST">
                        <input type="hidden" name="_token" value="{{ csrf_token('ajax_global') }}">

                        {# Pessoa Vinculada #}
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2">
                                    <i class="fas fa-user"></i> Pessoa Vinculada
                                </h6>
                            </div>

                            {# Pessoa já selecionada (edit mode ou após seleção) #}
                            <div class="col-12" id="pessoa-selecionada"
                                 {% if not (lancamento and lancamento.inquilino) %}style="display:none;"{% endif %}>
                                <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                                    <div>
                                        <i class="fas fa-user-check me-2"></i>
                                        <strong id="pessoa-nome-display">
                                            {% if lancamento and lancamento.inquilino %}{{ lancamento.inquilino.nome }}{% endif %}
                                        </strong>
                                        <span class="badge bg-secondary ms-2" id="pessoa-id-badge">
                                            {% if lancamento and lancamento.inquilino %}#{{ lancamento.inquilino.id }}{% endif %}
                                        </span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="btn-remover-pessoa">
                                        <i class="fas fa-times"></i> Remover
                                    </button>
                                </div>
                                <input type="hidden" name="inquilino" id="inquilino-id"
                                       value="{{ lancamento and lancamento.inquilino ? lancamento.inquilino.id : '' }}">
                            </div>

                            {# Interface de busca #}
                            <div class="col-12" id="busca-pessoa-interface"
                                 {% if lancamento and lancamento.inquilino %}style="display:none;"{% endif %}>
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-5">
                                        <label class="form-label form-label-sm">Nome, ID ou CPF/CNPJ</label>
                                        <input type="text" id="busca-pessoa-texto" class="form-control"
                                               placeholder="Digite pelo menos 2 caracteres...">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label form-label-sm">Filtrar por tipo</label>
                                        <select id="busca-pessoa-tipo" class="form-select">
                                            <option value="">Todos os tipos</option>
                                            <option value="1">Fiador</option>
                                            <option value="2">Corretor</option>
                                            <option value="3">Corretora</option>
                                            <option value="4">Locador / Proprietário</option>
                                            <option value="5">Pretendente</option>
                                            <option value="6">Contratante</option>
                                            <option value="7">Sócio</option>
                                            <option value="8">Advogado</option>
                                            <option value="12">Inquilino</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" id="btn-buscar-pessoa" class="btn btn-primary w-100">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                    </div>
                                </div>
                                <div id="busca-resultados" class="mt-2" style="display:none;">
                                    <div class="list-group border rounded" id="lista-resultados"
                                         style="max-height:220px; overflow-y:auto;"></div>
                                </div>
                            </div>
                        </div>

                        {# Informações Básicas #}
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2">Informações Básicas</h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tipo de Lançamento</label>
                                <select name="tipoLancamento" class="form-select" required>
                                    <option value="aluguel" {% if lancamento.tipoLancamento|default('') == 'aluguel' %}selected{% endif %}>Aluguel</option>
                                    <option value="condominio" {% if lancamento.tipoLancamento|default('') == 'condominio' %}selected{% endif %}>Condomínio</option>
                                    <option value="iptu" {% if lancamento.tipoLancamento|default('') == 'iptu' %}selected{% endif %}>IPTU</option>
                                    <option value="agua" {% if lancamento.tipoLancamento|default('') == 'agua' %}selected{% endif %}>Água</option>
                                    <option value="luz" {% if lancamento.tipoLancamento|default('') == 'luz' %}selected{% endif %}>Luz</option>
                                    <option value="gas" {% if lancamento.tipoLancamento|default('') == 'gas' %}selected{% endif %}>Gás</option>
                                    <option value="outros" {% if lancamento.tipoLancamento|default('') == 'outros' %}selected{% endif %}>Outros</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Competência</label>
                                <input type="month" name="competencia" class="form-control" required
                                       value="{{ lancamento.competencia|default('now'|date('Y-m')) }}">
                            </div>
                        </div>

                        {# Datas #}
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2">Datas</h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data de Vencimento</label>
                                <input type="date" name="dataVencimento" class="form-control" required
                                       value="{{ lancamento.dataVencimento|default('now'|date('Y-m-d')) }}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data Limite</label>
                                <input type="date" name="dataLimite" class="form-control"
                                       value="{{ lancamento.dataLimite|default('') }}">
                            </div>
                        </div>

                        {# Valores #}
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2">Valores</h6>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Valor Principal</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorPrincipal" class="form-control valor-monetario" required
                                           value="{{ lancamento.valorPrincipal|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Condomínio</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorCondominio" class="form-control valor-monetario"
                                           value="{{ lancamento.valorCondominio|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">IPTU</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorIptu" class="form-control valor-monetario"
                                           value="{{ lancamento.valorIptu|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Água</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorAgua" class="form-control valor-monetario"
                                           value="{{ lancamento.valorAgua|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Luz</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorLuz" class="form-control valor-monetario"
                                           value="{{ lancamento.valorLuz|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Gás</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorGas" class="form-control valor-monetario"
                                           value="{{ lancamento.valorGas|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Outros</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorOutros" class="form-control valor-monetario"
                                           value="{{ lancamento.valorOutros|default('0.00') }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Desconto</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" name="valorDesconto" class="form-control valor-monetario"
                                           value="{{ lancamento.valorDesconto|default('0.00') }}">
                                </div>
                            </div>
                        </div>

                        {# Descrição #}
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-muted border-bottom pb-2">Descrição</h6>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descrição</label>
                                <input type="text" name="descricao" class="form-control"
                                       value="{{ lancamento.descricao|default('') }}"
                                       placeholder="Ex: Aluguel de Janeiro/2025">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Observações</label>
                                <textarea name="observacoes" class="form-control" rows="3">{{ lancamento.observacoes|default('') }}</textarea>
                            </div>
                        </div>

                        {# Botões #}
                        <div class="d-flex justify-content-between">
                            <a href="{{ path('app_financeiro_index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check"></i> {{ isEdit ? 'Atualizar' : 'Salvar' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        window.LANCAMENTO_ROUTES = {
            buscarPessoa: '{{ path('app_pessoa_buscar_rapido') }}'
        };
    </script>
    {{ encore_entry_script_tags('financeiro_form') }}
{% endblock %}
