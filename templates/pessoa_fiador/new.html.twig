{% extends 'base.html.twig' %}

{% block title %}Novo Fiador{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include '_partials/breadcrumb.html.twig' with {
        'items': [
            {'label': 'Fiadores', 'url': path('app_pessoa_fiador_index')}
        ],
        'current': 'Novo Fiador'
    } %}
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-handshake"></i> Novo Fiador</h1>
            
            <!-- Interface de Busca Inteligente -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3><i class="fas fa-search"></i> Buscar Pessoa para Cadastro de Fiador</h3>
                    <small class="text-muted">Evite duplicatas buscando se a pessoa já está cadastrada no sistema</small>
                </div>
                <div class="card-body">
                    <!-- Critério de Busca -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="searchCriteria" class="form-label">Como deseja buscar?</label>
                            <select id="searchCriteria" class="form-select">
                                <option value="">Selecione o critério de busca</option>
                                <option value="cpf">CPF (Pessoa Física)</option>
                                <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                                <option value="nome">Nome Completo</option>
                                <option value="id">ID da Pessoa</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="searchValue" class="form-label">Valor da Busca</label>
                            <input type="text" id="searchValue" class="form-control" placeholder="Digite o valor para busca" disabled>
                            <div class="form-text" id="searchHelp"></div>
                        </div>
                    </div>
                    
                    <!-- Campo adicional para nome (CPF/CNPJ de desempate) -->
                    <div class="row mb-3" id="additionalDocumentRow" style="display: none;">
                        <div class="col-md-6">
                            <label for="additionalDocumentType" class="form-label">Tipo de Documento</label>
                            <select id="additionalDocumentType" class="form-select">
                                <option value="cpf">CPF (Pessoa Física)</option>
                                <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="additionalDocumentValue" class="form-label">Número do Documento</label>
                            <input type="text" id="additionalDocumentValue" class="form-control" placeholder="Digite o CPF ou CNPJ">
                            <div class="form-text">Para evitar duplicatas quando há nomes similares</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="btn-search" disabled>
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button type="button" class="btn btn-secondary" id="btn-clear">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                    
                    <!-- Resultados da busca -->
                    <div id="search-results" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="search-message"></span>
                        </div>
                        <div id="results-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Formulário Principal (Inicialmente Oculto) -->
            <div id="main-form" style="display: none;">
                {{ form_start(form) }}
                
                <!-- Campo oculto para ID da pessoa (quando pessoa existente) -->
                {{ form_row(form.pessoaId) }}
                
                <!-- Dados da Pessoa -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-user"></i> Dados da Pessoa</h3>
                        <small class="text-muted" id="pessoa-status"></small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                {{ form_row(form.nome) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(form.searchTerm) }}
                            </div>
                        </div>
                        
                        <!-- Campos específicos para Pessoa Física -->
                        <div id="campos-pessoa-fisica">
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(form.dataNascimento) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(form.estadoCivil) }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(form.nacionalidade) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(form.naturalidade) }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(form.nomePai) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(form.nomeMae) }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campos gerais -->
                        <div class="row">
                            <div class="col-md-6">
                                {{ form_row(form.renda) }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                {{ form_row(form.observacoes) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Telefones -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-phone"></i> Telefones</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-telefone">
                            <i class="fas fa-plus"></i> Adicionar Telefone
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="telefones-container">
                            <p class="text-muted">Nenhum telefone adicionado.</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de Endereços -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-map-marker-alt"></i> Endereços</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-endereco">
                            <i class="fas fa-plus"></i> Adicionar Endereço
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="enderecos-container">
                            <p class="text-muted">Nenhum endereço adicionado.</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de Emails -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-envelope"></i> Emails</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-email">
                            <i class="fas fa-plus"></i> Adicionar Email
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="emails-container">
                            <p class="text-muted">Nenhum email adicionado.</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de Chaves PIX -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-qrcode"></i> Chaves PIX</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-pix">
                            <i class="fas fa-plus"></i> Adicionar Chave PIX
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pix-container">
                            <p class="text-muted">Nenhuma chave PIX adicionada.</p>
                        </div>
                    </div>
                </div>

                <!-- Seção de Documentos -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-file-alt"></i> Documentos</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-documento">
                            <i class="fas fa-plus"></i> Adicionar Documento
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="documentos-container">
                            <p class="text-muted">Nenhum documento adicionado.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Dados do Fiador -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-handshake"></i> Dados do Fiador</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form_row(form.valorLimite) }}
                            </div>
                            <div class="col-md-6">
                                {{ form_row(form.tipoGarantia) }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ form_row(form.percentualGarantia) }}
                            </div>
                            <div class="col-md-6">
                                {{ form_row(form.situacao) }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                {{ form_row(form.observacoesFiador) }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campo Cônjuge -->
                <div class="card mb-4" id="conjuge-section" style="display: none;">
                    <div class="card-header">
                        <h3><i class="fas fa-heart"></i> Dados do Cônjuge</h3>
                        <small class="text-muted">Aplicável apenas para pessoas físicas</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="temConjuge">
                                    <label class="form-check-label" for="temConjuge">
                                        Esta pessoa possui cônjuge
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="campos-conjuge" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Você pode buscar um cônjuge já cadastrado ou criar um novo registro.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Buscar Cônjuge</label>
                                    <input type="text" class="form-control" id="conjuge-search" placeholder="Digite o nome ou CPF do cônjuge">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary" id="btn-search-conjuge">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="btn-new-conjuge">
                                            <i class="fas fa-plus"></i> Novo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="conjuge-results" class="mt-3" style="display: none;"></div>
                            {{ form_widget(form.conjuge, {'attr': {'style': 'display: none'}}) }}
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-arrow-left"></i> Voltar
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Salvar Fiador
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

<!-- Modais para Cadastro de Novos Tipos -->

<!-- Modal Novo Tipo de Telefone -->
<div class="modal fade" id="modalNovoTipoTelefone" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Tipo de Telefone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="novoTipoTelefone" class="form-label">Nome do Tipo</label>
                    <input type="text" class="form-control" id="novoTipoTelefone" placeholder="Ex: Celular, Comercial, Residencial">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarTipoTelefone">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Tipo de Endereço -->
<div class="modal fade" id="modalNovoTipoEndereco" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Tipo de Endereço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="novoTipoEndereco" class="form-label">Nome do Tipo</label>
                    <input type="text" class="form-control" id="novoTipoEndereco" placeholder="Ex: Residencial, Comercial, Correspondência">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarTipoEndereco">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Tipo de Email -->
<div class="modal fade" id="modalNovoTipoEmail" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Tipo de Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="novoTipoEmail" class="form-label">Nome do Tipo</label>
                    <input type="text" class="form-control" id="novoTipoEmail" placeholder="Ex: Pessoal, Profissional, Corporativo">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarTipoEmail">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Tipo de Chave PIX -->
<div class="modal fade" id="modalNovoTipoChavePix" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Tipo de Chave PIX</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="novoTipoChavePix" class="form-label">Nome do Tipo</label>
                    <input type="text" class="form-control" id="novoTipoChavePix" placeholder="Ex: CPF, CNPJ, Email, Telefone, Chave Aleatória">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarTipoChavePix">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Tipo de Documento -->
<div class="modal fade" id="modalNovoTipoDocumento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Tipo de Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="novoTipoDocumento" class="form-label">Nome do Tipo</label>
                    <input type="text" class="form-control" id="novoTipoDocumento" placeholder="Ex: RG, CPF, CNH, Passaporte">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarTipoDocumento">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Definir URL globalmente usando gerador do Symfony
    window.SEARCH_URL = '{{ path("app_pessoa_fiador_app_pessoa_fiador_search_pessoa_advanced") }}';
    
    // Definir IDs de campos do formulário usando os IDs reais gerados pelo Symfony
    window.FORM_IDS = {
        pessoaId: '{{ form.pessoaId.vars.id }}',
        nome: '{{ form.nome.vars.id }}',
        searchTerm: '{{ form.searchTerm.vars.id }}',
        dataNascimento: '{{ form.dataNascimento.vars.id }}',
        estadoCivil: '{{ form.estadoCivil.vars.id }}',
        nacionalidade: '{{ form.nacionalidade.vars.id }}',
        naturalidade: '{{ form.naturalidade.vars.id }}',
        nomePai: '{{ form.nomePai.vars.id }}',
        nomeMae: '{{ form.nomeMae.vars.id }}',
        renda: '{{ form.renda.vars.id }}',
        observacoes: '{{ form.observacoes.vars.id }}'
    };
</script>

<script src="{{ asset('js/pessoa_fiador/pessoa_fiador.js') }}"></script>
{% endblock %}