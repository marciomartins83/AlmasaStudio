{# templates/pessoa/pessoa_form.html.twig - Formulário unificado para criar/editar pessoa #}
{% extends 'base.html.twig' %}

{% block title %}Gestão de Pessoa{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include '_partials/breadcrumb.html.twig' with {
        'items': [
            {'label': 'Pessoas', 'url': path('app_pessoa_index')}
        ],
        'current': 'Gestão de Pessoa'
    } %}
    
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-users"></i> Gestão de Pessoa</h1>

            <!-- Interface de Busca Inteligente -->
            <div class="card mb-4" id="search-interface" {% if isEditMode %}style="display: none;"{% endif %}>
                <div class="card-header">
                    <h3><i class="fas fa-search"></i> Buscar Pessoa</h3>
                    <small class="text-muted">Busque para editar ou criar uma nova pessoa</small>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="searchCriteria" class="form-label">Como deseja buscar?</label>
                            <select id="searchCriteria" class="form-select">
                                <option value="">Selecione o critério de busca</option>
                                <option value="cpf">CPF (Pessoa Física)</option>
                                <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                                <option value="nome">Nome Completo</option>
                                <option value="id">ID da Pessoa</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="searchValue" class="form-label">Valor da Busca</label>
                            <input type="text" id="searchValue" class="form-control" placeholder="Digite o valor para busca" disabled>
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="additionalDocumentRow" style="display: none;">
                        <div class="col-md-6">
                            <label for="additionalDocumentType" class="form-label">Tipo de Documento</label>
                            <select id="additionalDocumentType" class="form-select">
                                <option value="cpf">CPF (Pessoa Física)</option>
                                <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="additionalDocumentValue" class="form-label">Número do Documento</label>
                            <input type="text" id="additionalDocumentValue" class="form-control" placeholder="Digite o CPF ou CNPJ">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="btn-search" disabled>
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button type="button" class="btn btn-secondary" id="btn-clear">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                    
                    <div id="search-results" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="search-message"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulário Principal -->
            <div id="main-form" {% if not isEditMode %}style="display: none;"{% endif %}>
                {{ form_start(form) }}
                
                {{ form_row(form.pessoaId) }}
                
                <!-- Dados da Pessoa PRINCIPAL -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-user"></i> Dados da Pessoa Principal</h3>
                        <small class="text-muted" id="pessoa-status"></small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                {{ form_row(form.nome) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(form.searchTerm) }}
                            </div>
                        </div>
                        
                        <div id="campos-pessoa-fisica">
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(form.dataNascimento) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(form.estadoCivil) }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="{{ form.nacionalidade.vars.id }}" class="form-label">Nacionalidade</label>
                                    <div class="input-group">
                                        {{ form_widget(form.nacionalidade, {'attr': {'class': 'form-select'}}) }}
                                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalNovaNacionalidade">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.naturalidade.vars.id }}" class="form-label">Naturalidade</label>
                                    <div class="input-group">
                                        {{ form_widget(form.naturalidade, {'attr': {'class': 'form-select'}}) }}
                                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalNovaNaturalidade">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form_row(form.nomePai) }}
                                </div>
                                <div class="col-md-6">
                                    {{ form_row(form.nomeMae) }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ form_row(form.renda) }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                {{ form_row(form.observacoes) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ⭐ TIPOS DE PESSOA - SOMENTE PARA PESSOA PRINCIPAL ⭐ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-tags"></i> Tipos de Pessoa Principal</h3>
                        <small class="text-muted">Defina os papéis desta pessoa no sistema (fiador, locador, etc.)</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <select id="select-tipo-pessoa" class="form-select">
                                    <option value="">Selecione um tipo para adicionar...</option>
                                    <option value="fiador">Fiador</option>
                                    <option value="corretor">Corretor</option>
                                    <option value="corretora">Corretora</option>
                                    <option value="locador">Locador</option>
                                    <option value="pretendente">Pretendente</option>
                                    <option value="contratante">Contratante</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-primary w-100" id="add-tipo-pessoa">
                                    <i class="fas fa-plus"></i> Adicionar Tipo
                                </button>
                            </div>
                        </div>
                        
                        <div id="tipos-pessoa-container">
                            <p class="text-muted">Nenhum tipo selecionado. Adicione pelo menos um tipo de pessoa.</p>
                        </div>
                    </div>
                </div>

                <!-- Dados Múltiplos da Pessoa Principal -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-briefcase"></i> Profissões</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-profissao">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="profissoes-container">
                            <p class="text-muted">Nenhuma profissão adicionada.</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-phone"></i> Telefones</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-telefone">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="telefones-container">
                            <p class="text-muted">Nenhum telefone adicionado.</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-map-marker-alt"></i> Endereços</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-endereco">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="enderecos-container">
                            <p class="text-muted">Nenhum endereço adicionado.</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-envelope"></i> Emails</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-email">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="emails-container">
                            <p class="text-muted">Nenhum email adicionado.</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-qrcode"></i> Chaves PIX</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-pix">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="pix-container">
                            <p class="text-muted">Nenhuma chave PIX adicionada.</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-file-alt"></i> Documentos</h3>
                        <button type="button" class="btn btn-sm btn-primary" id="add-documento">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="documentos-container">
                            <p class="text-muted">Nenhum documento adicionado.</p>
                        </div>
                    </div>
                </div>

                <!-- ⭐ CÔNJUGE - SEM SEÇÃO DE TIPOS ⭐ -->
                <div class="card mb-4" id="conjuge-section" style="display: none;">
                    <div class="card-header">
                        <h3><i class="fas fa-heart"></i> Dados do Cônjuge</h3>
                        <small class="text-muted">
                            <strong>Importante:</strong> O cônjuge pode ter seus próprios tipos (fiador, locador, etc.) 
                            quando você o editar como pessoa principal. Aqui você apenas define os dados pessoais.
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="temConjuge">
                                    <label class="form-check-label" for="temConjuge">
                                        Esta pessoa possui cônjuge
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="campos-conjuge" style="display: none;">
                            <input type="hidden" name="conjuge_id" value="">
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Você pode buscar um cônjuge já cadastrado ou criar um novo.
                                <br>
                                <small><strong>Nota:</strong> Os tipos de pessoa do cônjuge (fiador, locador, etc.) só aparecem quando você edita o cônjuge como pessoa principal.</small>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="conjugeSearchCriteria" class="form-label">Como deseja buscar?</label>
                                    <select id="conjugeSearchCriteria" class="form-select">
                                        <option value="">Selecione o critério</option>
                                        <option value="cpf">CPF</option>
                                        <option value="nome">Nome Completo</option>
                                        <option value="id">ID da Pessoa</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="conjugeSearchValue" class="form-label">Valor da Busca</label>
                                    <input type="text" id="conjugeSearchValue" class="form-control" placeholder="Digite o valor" disabled>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary" id="btn-search-conjuge" disabled>
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="btn-new-conjuge">
                                            <i class="fas fa-plus"></i> Novo
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="conjuge-results" class="mt-3" style="display: none;"></div>
                            
                            <!-- Dados Pessoais do Cônjuge -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-user"></i> Dados Pessoais do Cônjuge</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label">Nome Completo</label>
                                            <input type="text" class="form-control" name="novo_conjuge[nome]" placeholder="Nome completo">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">CPF</label>
                                            <input type="text" class="form-control" name="novo_conjuge[cpf]" placeholder="000.000.000-00">
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Data de Nascimento</label>
                                            <input type="date" class="form-control" name="novo_conjuge[data_nascimento]">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Estado Civil</label>
                                            <select class="form-select" name="novo_conjuge[estado_civil]">
                                                <option value="">Selecione...</option>
                                                {% for estado in form.estadoCivil.vars.choices %}
                                                    <option value="{{ estado.value }}">{{ estado.label }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nacionalidade</label>
                                            <div class="input-group">
                                                <select class="form-select" name="novo_conjuge[nacionalidade]">
                                                    <option value="">Selecione...</option>
                                                    {% for nac in form.nacionalidade.vars.choices %}
                                                        <option value="{{ nac.value }}">{{ nac.label }}</option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalNovaNacionalidade">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Naturalidade</label>
                                            <div class="input-group">
                                                <select class="form-select" name="novo_conjuge[naturalidade]">
                                                    <option value="">Selecione...</option>
                                                    {% for nat in form.naturalidade.vars.choices %}
                                                        <option value="{{ nat.value }}">{{ nat.label }}</option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalNovaNaturalidade">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Nome do Pai</label>
                                            <input type="text" class="form-control" name="novo_conjuge[nome_pai]">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Nome da Mãe</label>
                                            <input type="text" class="form-control" name="novo_conjuge[nome_mae]">
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Renda</label>
                                            <input type="number" class="form-control" name="novo_conjuge[renda]" step="0.01">
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <label class="form-label">Observações</label>
                                            <textarea class="form-control" name="novo_conjuge[observacoes]" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dados Múltiplos do Cônjuge -->
                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-phone"></i> Telefones do Cônjuge</h5>
                                    <button type="button" class="btn btn-sm btn-primary" id="add-conjuge-telefone">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="conjuge-telefones-container">
                                        <p class="text-muted">Nenhum telefone adicionado.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Endereços do Cônjuge</h5>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="copy-enderecos-to-conjuge" title="Copiar endereços da pessoa principal">
                                                <i class="fas fa-copy"></i> Adicionar mesmo do Cônjuge
                                            </button>
                                            <button type="button" class="btn btn-sm btn-primary" id="add-conjuge-endereco">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="conjuge-enderecos-container">
                                        <p class="text-muted">Nenhum endereço adicionado.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-envelope"></i> Emails do Cônjuge</h5>
                                    <button type="button" class="btn-sm btn-primary" id="add-conjuge-email">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="conjuge-emails-container">
                                        <p class="text-muted">Nenhum email adicionado.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-qrcode"></i> Chaves PIX do Cônjuge</h5>
                                    <button type="button" class="btn btn-sm btn-primary" id="add-conjuge-pix">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="conjuge-pix-container">
                                        <p class="text-muted">Nenhuma chave PIX adicionada.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-file-alt"></i> Documentos do Cônjuge</h5>
                                    <button type="button" class="btn btn-sm btn-primary" id="add-conjuge-documento">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="conjuge-documentos-container">
                                        <p class="text-muted">Nenhum documento adicionado.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-briefcase"></i> Profissões do Cônjuge</h5>
                                    <button type="button" class="btn btn-sm btn-primary" id="add-conjuge-profissao">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="conjuge-profissoes-container">
                                        <p class="text-muted">Nenhuma profissão adicionada.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 text-end">
                                <a href="{{ path('app_pessoa_index') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Voltar
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

{% include 'pessoa/partials/_modals.html.twig' %}

<script>
    window.ROUTES = {
        subform: '{{ path("app_pessoa__subform") }}',
        searchPessoa: '{{ path("app_pessoa_search_pessoa_advanced") }}',
        loadTipos: '{{ path("app_pessoa_load_tipos", {"entidade": "__ENTIDADE__"}) }}',
        salvarTipo: '{{ path("app_pessoa_salvar_tipo", {"entidade": "__ENTIDADE__"}) }}',
        buscarCep: '{{ path("app_pessoa_buscar_cep") }}',
        searchConjuge: '{{ path("app_pessoa_search_conjuge") }}',
        newPessoa: '{{ path("app_pessoa_new") }}',
        editPessoa: '{{ path("app_pessoa_edit", {"id": 999999})|replace({"999999":"__ID__"}) }}',
        salvarNacionalidade: '{{ path("app_nacionalidade_salvar") }}',
        salvarNaturalidade: '{{ path("app_naturalidade_salvar") }}'
    };

    window.FORM_IDS = {
        pessoaId: '{{ form.pessoaId.vars.id }}',
        nome: '{{ form.nome.vars.id }}',
        searchTerm: '{{ form.searchTerm.vars.id }}',
        dataNascimento: '{{ form.dataNascimento.vars.id }}',
        estadoCivil: '{{ form.estadoCivil.vars.id }}',
        nacionalidade: '{{ form.nacionalidade.vars.id }}',
        naturalidade: '{{ form.naturalidade.vars.id }}',
        nomePai: '{{ form.nomePai.vars.id }}',
        nomeMae: '{{ form.nomeMae.vars.id }}',
        renda: '{{ form.renda.vars.id }}',
        observacoes: '{{ form.observacoes.vars.id }}',
        conjuge: '{{ form.conjuge.vars.id }}'
    };

    // Variáveis de modo de edição
    window.IS_EDIT_MODE = {{ isEditMode ? 'true' : 'false' }};
    window.PESSOA_ID = {{ pessoaId ?? 'null' }};
</script>

<script src="{{ asset('js/pessoa/pessoa.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_tipos.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_telefones.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_enderecos.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_emails.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_documentos.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_chave_pix.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_profissoes.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_modals.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_form.js') }}"></script>
<script src="{{ asset('js/pessoa/pessoa_conjuge.js') }}"></script>
<script src="{{ asset('js/pessoa/conjuge_telefones.js') }}"></script>
<script src="{{ asset('js/pessoa/conjuge_enderecos.js') }}"></script>
<script src="{{ asset('js/pessoa/conjuge_emails.js') }}"></script>
<script src="{{ asset('js/pessoa/conjuge_documentos.js') }}"></script>
<script src="{{ asset('js/pessoa/conjuge_chave_pix.js') }}"></script>
<script src="{{ asset('js/pessoa/conjuge_profissoes.js') }}"></script>
{% endblock %}