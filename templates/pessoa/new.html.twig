{% extends 'base.html.twig' %}

{% block title %}Nova Pessoa{% endblock %}

{% block content %}
<div class="container-fluid">
    {% include '_partials/breadcrumb.html.twig' with {
        'items': [
            {'label': 'Pessoas', 'url': path('app_pessoa_index')}
        ],
        'current': 'Nova Pessoa'
    } %}
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-user-plus"></i> Nova Pessoa</h1>
            
            <!-- Interface de Busca Inteligente -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3><i class="fas fa-search"></i> Buscar Pessoa para Cadastro</h3>
                    <small class="text-muted">Evite duplicatas buscando se a pessoa já está cadastrada no sistema</small>
                </div>
                <div class="card-body">
                    <!-- Critério de Busca -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="searchCriteria" class="form-label">Como deseja buscar?</label>
                            <select id="searchCriteria" class="form-select">
                                <option value="">Selecione o critério de busca</option>
                                <option value="cpf">CPF (Pessoa Física)</option>
                                <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                                <option value="nome">Nome Completo</option>
                                <option value="id">ID da Pessoa</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="searchValue" class="form-label">Valor da Busca</label>
                            <input type="text" id="searchValue" class="form-control" placeholder="Digite o valor para busca" disabled>
                            <div class="form-text" id="searchHelp"></div>
                        </div>
                    </div>
                    
                    <!-- Campo adicional para nome (CPF/CNPJ de desempate) -->
                    <div class="row mb-3" id="additionalDocumentRow" style="display: none;">
                        <div class="col-md-6">
                            <label for="additionalDocumentType" class="form-label">Tipo de Documento</label>
                            <select id="additionalDocumentType" class="form-select">
                                <option value="cpf">CPF (Pessoa Física)</option>
                                <option value="cnpj">CNPJ (Pessoa Jurídica)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="additionalDocumentValue" class="form-label">Número do Documento</label>
                            <input type="text" id="additionalDocumentValue" class="form-control" placeholder="Digite o CPF ou CNPJ">
                            <div class="form-text">Para evitar duplicatas quando há nomes similares</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="btn-search" disabled>
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button type="button" class="btn btn-secondary" id="btn-clear">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                    
                    <!-- Resultados da busca -->
                    <div id="search-results" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <span id="search-message"></span>
                        </div>
                        <div id="results-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Formulário Principal (Inicialmente Oculto) -->
            <div id="main-form" style="display: none;">
                {{ form_start(form) }}
                
                <!-- Dados da Pessoa -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-user"></i> Dados da Pessoa</h3>
                        <small class="text-muted" id="pessoa-status"></small>
                    </div>
                    <div class="card-body">
                        {{ form_row(form.nome) }}
                        {{ form_row(form.dataNascimento) }}
                        {{ form_row(form.estadoCivil) }}
                        {{ form_row(form.nacionalidade) }}
                        {{ form_row(form.naturalidade) }}
                        {{ form_row(form.nomePai) }}
                        {{ form_row(form.nomeMae) }}
                        {{ form_row(form.renda) }}
                        {{ form_row(form.observacoes) }}
                    </div>
                </div>

                <!-- Tipo de Pessoa e Sub-formulário dinâmico -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-briefcase"></i> Tipo de Pessoa</h3>
                    </div>
                    <div class="card-body">
                        {{ form_row(form.tipoPessoa) }}
                        <div id="sub-form-container" class="mt-3">
                            {# O sub-formulário (fiador, corretor, etc.) será carregado aqui via AJAX #}
                        </div>
                    </div>
                </div>

                <!-- Seções de Contato, Documentos, etc. -->
                {% include 'pessoa/partials/_contact_sections.html.twig' %}

                <!-- Botões de Ação -->
                <div class="card">
                    <div class="card-body text-end">
                        <a href="{{ path('app_pessoa_index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar Pessoa
                        </button>
                    </div>
                </div>
                
                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

{% include 'pessoa/partials/_modals.html.twig' %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        window.FORM_IDS = {
            pessoaId: '{{ form.pessoaId.vars.id | default('') }}',
            nome: '{{ form.nome.vars.id | default('') }}',
            // ... (outros campos base da pessoa)
        };
        
        window.ROUTES = {
            subform: '{{ path("app_pessoa_subform") }}',
            // ... (outras rotas)
        };
    </script>
    <script src="{{ asset('js/pessoa/new.js') }}"></script>
    {# Adicionar outros scripts necessários para as seções de contato, cônjuge, etc. #}
    <script src="{{ asset('js/pessoa/pessoa.js') }}"></script>
    <script src="{{ asset('js/pessoa/pessoa_enderecos.js') }}"></script>
    <script src="{{ asset('js/pessoa/pessoa_telefones.js') }}"></script>
    <script src="{{ asset('js/pessoa/pessoa_documentos.js') }}"></script>
    <script src="{{ asset('js/pessoa/pessoa_chave_pix.js') }}"></script>
    <script src="{{ asset('js/pessoa/pessoa_emails.js') }}"></script>
    <script src="{{ asset('js/pessoa/pessoa_conjuge.js') }}"></script>
{% endblock %}