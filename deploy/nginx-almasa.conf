# Nginx config para AlmasaStudio como subfolder /almasa em liviago.com.br
# Inclua este bloco no server block: include /var/www/AlmasaStudio/deploy/nginx-almasa.conf;

location ^~ /almasa {
    alias /var/www/AlmasaStudio/public;

    # Arquivos estáticos com cache (regex + alias precisa de capture group)
    location ~* ^/almasa/(.+\.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|json|map))$ {
        alias /var/www/AlmasaStudio/public/$1;
        expires 30d;
        access_log off;
        add_header Cache-Control "public, immutable";
    }

    # Bloquear acesso a arquivos sensíveis
    location ~ /almasa/\. {
        deny all;
    }

    # Try files estáticos, senão vai para index.php
    if (!-f $request_filename) {
        rewrite ^/almasa/(.*)$ /almasa/index.php last;
    }

    # Handler PHP para index.php
    location ~ ^/almasa/index\.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_param SCRIPT_FILENAME /var/www/AlmasaStudio/public/index.php;
        fastcgi_param DOCUMENT_ROOT /var/www/AlmasaStudio/public;

        # Extrair PATH_INFO
        fastcgi_split_path_info ^(/almasa/index\.php)(/.*)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param REQUEST_URI $request_uri;

        include fastcgi_params;
    }
}
